<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>블랙잭 - ItemGame</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/blackjack.css">
</head>
<body class="blackjack-page">
    <!-- 헤더 -->
    <header class="header">
        <div class="header-logo" onclick="location.href='index.html'" style="cursor:pointer">ITEM<span>GAME</span></div>
        <div class="header-center">
            <div class="header-chips">
                <div class="chip-icon">$</div>
                <div class="chip-balance" id="headerChips">0</div>
            </div>
            <div class="level-badge">
                <span class="level-text" id="levelDisplay">Lv.1</span>
                <div class="xp-bar"><div class="xp-bar-fill" id="xpBarFill"></div></div>
                <span class="xp-text" id="xpText">0/500</span>
            </div>
        </div>
        <nav class="header-nav">
            <button class="nav-btn" onclick="location.href='index.html'">로비</button>
            <button class="sound-toggle" id="soundToggleBtn" onclick="SoundManager.toggleMute()" title="소리 끄기">🔊</button>
        </nav>
    </header>

    <!-- 메인 -->
    <main class="container">
        <div class="bj-container">
            <!-- 블랙잭 테이블 -->
            <div class="bj-table" id="bjTableOuter">
                <div class="bj-title">BLACKJACK</div>

                <!-- 슈 인디케이터 -->
                <div class="shoe-indicator" id="shoeIndicator">
                    <span id="shoeText">312장</span>
                    <div class="shoe-bar">
                        <div class="shoe-bar-fill" id="shoeBarFill" style="width:100%"></div>
                    </div>
                </div>

                <!-- 테이블 영역 (JS 렌더링) -->
                <div id="bjTable">
                    <div class="hand-area">
                        <div class="hand-label">
                            <span class="name">딜러</span>
                            <span class="score">-</span>
                        </div>
                        <div class="cards-row"></div>
                    </div>
                    <div class="table-divider"></div>
                    <!-- 인슈어런스 라인 -->
                    <div class="insurance-line">INSURANCE PAYS 2:1</div>
                    <div class="hand-area">
                        <div class="hand-label">
                            <span class="name">플레이어</span>
                            <span class="score">-</span>
                        </div>
                        <div class="cards-row"></div>
                    </div>
                </div>

                <!-- 인슈어런스 오퍼 (JS 제어) -->
                <div class="insurance-offer" id="insuranceOffer">
                    <div class="insurance-offer-text">딜러가 에이스를 보여줍니다. 인슈어런스 하시겠습니까?</div>
                    <div class="insurance-offer-sub">베팅의 절반을 걸어 딜러 블랙잭에 2:1 보험</div>
                    <div class="insurance-offer-btns">
                        <button class="action-btn insurance" onclick="Blackjack.acceptInsurance()">인슈어런스</button>
                        <button class="action-btn surrender" onclick="Blackjack.declineInsurance()">거절</button>
                    </div>
                </div>

                <!-- 사이드벳 결과 (JS 렌더링) -->
                <div id="sideBetResult"></div>

                <!-- 결과 표시 -->
                <div class="result-display" id="bjResult"></div>

                <!-- 액션 버튼 -->
                <div class="bj-actions" id="actionArea" style="display:none">
                    <button class="action-btn hit" id="btnHit" onclick="Blackjack.hit()">HIT</button>
                    <button class="action-btn stand" id="btnStand" onclick="Blackjack.stand()">STAND</button>
                    <button class="action-btn double" id="btnDouble" onclick="Blackjack.doubleDown()">DOUBLE</button>
                    <button class="action-btn split" id="btnSplit" onclick="Blackjack.split()">SPLIT</button>
                    <button class="action-btn surrender" id="btnSurrender" onclick="Blackjack.surrender()">SURRENDER</button>
                </div>

                <!-- 상태 메시지 -->
                <div class="bj-status" id="bjStatus"></div>
            </div>

            <!-- 베팅 영역 -->
            <div class="bj-bet-area" id="betArea">
                <!-- 사이드벳 토글 -->
                <div class="side-bet-area">
                    <div class="side-bet-toggle" id="togglePerfectPairs" onclick="Blackjack.toggleSideBet('perfectPairs')">
                        <span class="side-bet-indicator"></span>
                        <span>Perfect Pairs</span>
                    </div>
                    <div class="side-bet-toggle" id="toggleTwentyOnePlus3" onclick="Blackjack.toggleSideBet('twentyOnePlus3')">
                        <span class="side-bet-indicator"></span>
                        <span>21+3</span>
                    </div>
                </div>

                <div style="display:flex;align-items:center;gap:16px;flex-wrap:wrap;justify-content:center">
                    <div class="bet-controls">
                        <span class="bet-label">BET</span>
                        <span class="bet-amount" id="currentBet">100</span>
                    </div>
                    <div class="chip-buttons">
                        <button class="chip-btn chip-50" onclick="Blackjack.addBet(50)">50</button>
                        <button class="chip-btn chip-100" onclick="Blackjack.addBet(100)">100</button>
                        <button class="chip-btn chip-500" onclick="Blackjack.addBet(500)">500</button>
                        <button class="chip-btn chip-1000" onclick="Blackjack.addBet(1000)">1K</button>
                        <button class="chip-btn chip-5000" onclick="Blackjack.addBet(5000)">5K</button>
                    </div>
                    <button class="btn btn-outline btn-sm" onclick="Blackjack.clearBet()">초기화</button>
                </div>
                <div style="display:flex;gap:12px;align-items:center;flex-wrap:wrap;justify-content:center">
                    <button class="deal-btn" id="btnDeal" onclick="Blackjack.deal()">DEAL</button>
                    <button class="rebet-btn" id="btnRebet" onclick="Blackjack.rebet()" style="display:none">REBET</button>
                    <button class="allin-btn" id="btnAllIn" onclick="Blackjack.allIn()" style="background:linear-gradient(135deg,#ff4444,#cc0000);color:#fff;border:2px solid #ff6666;padding:12px 24px;border-radius:12px;font-size:1rem;font-weight:bold;cursor:pointer;text-shadow:0 1px 3px rgba(0,0,0,0.5);letter-spacing:1px">ALL-IN</button>
                    <button class="btn btn-green btn-sm" id="btnNewGame" onclick="Blackjack.newGame()" style="display:none">새 게임</button>
                </div>
            </div>

            <!-- 통계 패널 -->
            <div class="stats-panel" id="statsPanel">
                <div class="stat-item wins">
                    <span class="stat-value" id="statWins">0</span>
                    <span class="stat-label">승리</span>
                </div>
                <div class="stat-item losses">
                    <span class="stat-value" id="statLosses">0</span>
                    <span class="stat-label">패배</span>
                </div>
                <div class="stat-item pushes">
                    <span class="stat-value" id="statPushes">0</span>
                    <span class="stat-label">무승부</span>
                </div>
                <div class="stat-item blackjacks">
                    <span class="stat-value" id="statBlackjacks">0</span>
                    <span class="stat-label">블랙잭</span>
                </div>
                <div class="stat-item">
                    <span class="stat-value" id="statHands">0</span>
                    <span class="stat-label">총 핸드</span>
                </div>
            </div>

            <!-- 규칙 -->
            <div class="rules-card">
                <h3>BLACKJACK 규칙</h3>
                <ul>
                    <li>21에 가장 가까운 쪽이 승리 (21 초과 시 버스트)</li>
                    <li>블랙잭 (첫 2장 21) → <strong style="color:#FFD700">1.5배 배당</strong></li>
                    <li>딜러는 17 미만이면 반드시 히트</li>
                    <li><strong>Hit</strong>: 카드 추가 | <strong>Stand</strong>: 현재 패로 승부</li>
                    <li><strong>Double</strong>: 베팅 2배 + 카드 1장만 추가</li>
                    <li><strong>Split</strong>: 같은 랭크 카드 → 2핸드로 분리</li>
                    <li><strong>Insurance</strong>: 딜러 에이스 시 보험 (2:1 배당)</li>
                    <li><strong>Surrender</strong>: 첫 2장에서 포기 → 베팅 절반 환불</li>
                    <li><strong>Perfect Pairs</strong>: 첫 2장이 같은 랭크 → 최대 25:1</li>
                    <li><strong>21+3</strong>: 내 2장 + 딜러 1장 = 포커 핸드 → 최대 100:1</li>
                </ul>
            </div>
        </div>
    </main>

    <!-- 코인 샤워 캔버스 -->
    <canvas id="coinShowerCanvas"></canvas>

    <!-- 토스트 -->
    <div class="toast-container" id="toastContainer"></div>

    <!-- 레벨업 오버레이 -->
    <div class="levelup-overlay" id="levelupOverlay">
        <div class="levelup-content">
            <div class="levelup-title" id="levelupTitle">LEVEL UP!</div>
            <div class="levelup-bonus" id="levelupBonus">+0 칩</div>
        </div>
    </div>

    <!-- 하단 네비게이션 (모바일) -->
    <nav class="bottom-nav">
        <div class="bottom-nav-inner">
            <a href="index.html" class="bottom-nav-item">
                <span class="nav-icon">🏠</span>
                <span class="nav-label">홈</span>
            </a>
            <a href="index.html#dailyBonusBanner" class="bottom-nav-item">
                <span class="nav-icon">🎁</span>
                <span class="nav-label">보너스</span>
            </a>
            <button class="bottom-nav-item" onclick="SoundManager.toggleMute()">
                <span class="nav-icon">🔊</span>
                <span class="nav-label">사운드</span>
            </button>
        </div>
    </nav>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- 스크립트 -->
    <script src="js/core/firebase-config.js"></script>
    <script src="js/core/chip-manager.js"></script>
    <script src="js/core/sound-manager.js"></script>
    <script src="js/core/coin-shower.js"></script>
    <script src="js/core/level-manager.js"></script>
    <script src="js/core/neon-particles.js"></script>
    <script src="js/games/blackjack.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', async () => {
            await ChipManager.init();
            SoundManager.init();
            CoinShower.init();
            LevelManager.init();
            NeonParticles.init();

            ChipManager.onBalanceChange(() => {
                document.getElementById('headerChips').textContent = ChipManager.formatBalance();
            });
            document.getElementById('headerChips').textContent = ChipManager.formatBalance();

            // 레벨업 리스너
            LevelManager.onEvent((event) => {
                if (event.type === 'levelup') {
                    const overlay = document.getElementById('levelupOverlay');
                    if (overlay) {
                        document.getElementById('levelupTitle').textContent = `LEVEL ${event.level}!`;
                        document.getElementById('levelupBonus').textContent = `+${event.bonus.toLocaleString()} 보너스 칩`;
                        overlay.classList.add('active');
                        setTimeout(() => overlay.classList.remove('active'), 3000);
                    }
                }
            });

            Blackjack.init();
        });
    </script>
</body>
</html>
