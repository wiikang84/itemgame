<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë°”ë‹¤ì´ì•¼ê¸° - ItemGame</title>
    <link rel="stylesheet" href="css/common.css">
    <link rel="stylesheet" href="css/sea-story.css">
</head>
<body class="sea-page">
    <!-- ìˆ˜ì¤‘ ê´‘ì„  ì˜¤ë²„ë ˆì´ -->
    <div class="spotlight-overlay"></div>
    <!-- ë²„ë¸” ìº”ë²„ìŠ¤ -->
    <canvas class="bubble-canvas" id="bubbleCanvas"></canvas>

    <!-- í—¤ë” -->
    <header class="header">
        <div class="header-logo" onclick="location.href='index.html'" style="cursor:pointer">ITEM<span>GAME</span></div>
        <div class="header-center">
            <div class="header-chips">
                <div class="chip-icon">$</div>
                <div class="chip-balance" id="headerChips">0</div>
            </div>
            <div class="level-badge">
                <span class="level-text" id="levelDisplay">Lv.1</span>
                <div class="xp-bar"><div class="xp-bar-fill" id="xpBarFill"></div></div>
                <span class="xp-text" id="xpText">0/500</span>
            </div>
        </div>
        <nav class="header-nav">
            <button class="nav-btn" onclick="location.href='index.html'">ë¡œë¹„</button>
            <button class="sound-toggle" id="soundToggleBtn" onclick="SoundManager.toggleMute()" title="ì†Œë¦¬ ë„ê¸°">ğŸ”Š</button>
        </nav>
    </header>

    <!-- ë©”ì¸ -->
    <main class="container">
        <div class="slot-cabinet">

            <!-- â•â•â• íƒ‘ ë°•ìŠ¤ (íƒ€ì´í‹€ + ì­íŒŸ) â•â•â• -->
            <div class="cabinet-top">
                <!-- LED ìŠ¤íŠ¸ë¦½ (ë¸”ë£¨+ì‹œì•ˆ êµì°¨) -->
                <div class="led-strip">
                    <span class="led-dot led-blue"></span>
                    <span class="led-dot led-cyan"></span>
                    <span class="led-dot led-blue"></span>
                    <span class="led-dot led-cyan"></span>
                    <span class="led-dot led-blue"></span>
                    <span class="led-dot led-cyan"></span>
                    <span class="led-dot led-blue"></span>
                    <span class="led-dot led-cyan"></span>
                    <span class="led-dot led-blue"></span>
                    <span class="led-dot led-cyan"></span>
                </div>
                <!-- ì¥ì‹ ìš”ì†Œ (í•´ì–‘ í…Œë§ˆ) -->
                <div class="cabinet-decorations">
                    <span class="deco-star left">ğŸš</span>
                    <span class="deco-diamond left-inner">ğŸŒŠ</span>
                    <span class="deco-crown">ğŸ”±</span>
                    <span class="deco-diamond right-inner">ğŸŒŠ</span>
                    <span class="deco-star right">ğŸš</span>
                </div>
                <div class="cabinet-corner-light left"></div>
                <div class="cabinet-corner-light right"></div>
                <div class="game-title">ë°”ë‹¤ì´ì•¼ê¸°</div>
                <div class="game-subtitle">SEA STORY &bull; OCEAN ADVENTURE</div>
                <!-- v5.0: í•˜ë‹¨ ê³¨ë“œ ë¼ì¸ -->
                <div class="gold-line-bottom"></div>
            </div>

            <!-- â•â•â• í”„ë¦¬ìŠ¤í•€ / ë©€í‹°í”Œë¼ì´ì–´ â•â•â• -->
            <div class="free-spin-counter" id="freeSpinCounter" style="display:none">
                <span class="fs-label">ë¬´ë£Œ ìŠ¤í•€</span>
                <span class="fs-count">0</span>
            </div>
            <div class="multiplier-display" id="multiplierDisplay" style="display:none">
                <span class="mult-label">ë°°ìœ¨</span>
                <span class="mult-value">x1</span>
            </div>

            <!-- â•â•â• ë¦´ í”„ë ˆì„ (ìºë¹„ë‹› ë©”ì¸ ë°”ë””) â•â•â• -->
            <div class="reels-frame">
                <div class="reels-container" id="reelsContainer">
                    <div class="reels-grid" id="reelsGrid">
                        <!-- JS ìƒì„± -->
                    </div>
                    <!-- ë¹„ë„¤íŠ¸ ì˜¤ë²„ë ˆì´ -->
                    <div class="reel-vignette"></div>
                </div>
            </div>

            <!-- â•â•â• ì¸í¬ ë°” (LED ë””ìŠ¤í”Œë ˆì´) â•â•â• -->
            <div class="info-bar">
                <div class="info-cell">
                    <span class="info-label">í¬ë ˆë”§</span>
                    <span class="info-value led-display" id="creditDisplay">0</span>
                </div>
                <div class="info-cell result-cell">
                    <span class="info-value result-text" id="slotResult">ìŠ¤í•€í•˜ì„¸ìš”</span>
                </div>
                <div class="info-cell">
                    <span class="info-label">ë‹¹ì²¨</span>
                    <span class="info-value led-display" id="winDisplay">0</span>
                </div>
            </div>

            <!-- ê²Œì„ í†µê³„ -->
            <div class="game-stats" id="gameStats">
                <span>ìŠ¤í•€: 0</span>
                <span>ë‹¹ì²¨: 0</span>
                <span>ìµœê³ : 0</span>
            </div>

            <!-- â•â•â• ìºë¹„ë‹› ë²¨ë¦¬ (ì»¨íŠ¸ë¡¤ ì˜ì—­) â•â•â• -->
            <div class="cabinet-belly">
                <!-- ë² íŒ… ì •ë³´ ë°” -->
                <div class="bet-info-bar">
                    <div class="bet-info-item">
                        <span class="bet-info-label">ë² íŒ…</span>
                        <span class="bet-info-value led-small" id="betAmount">100</span>
                    </div>
                    <div class="bet-info-item">
                        <span class="bet-info-label">ë¼ì¸</span>
                        <span class="bet-info-value led-small">9</span>
                    </div>
                    <div class="bet-info-item">
                        <span class="bet-info-label">ì´ ë² íŒ…</span>
                        <span class="bet-info-value led-small" id="totalBet">100</span>
                    </div>
                </div>

                <!-- v5.0: ìºë¹„ë‹› ë²„íŠ¼ ë°” (ì‚¼ë¶„í•  ë ˆì´ì•„ì›ƒ) -->
                <div class="cabinet-button-bar">
                    <!-- ì¢Œ: ë² íŒ… ì»¨íŠ¸ë¡¤ -->
                    <div class="btn-group btn-group-left">
                        <button class="cab-btn cab-btn-info" onclick="togglePaytable()" title="ë°°ë‹¹í‘œ">
                            <span class="cab-btn-icon">i</span>
                            <span class="cab-btn-label">ë°°ë‹¹</span>
                        </button>
                        <button class="cab-btn cab-btn-bet" onclick="SeaStory.decreaseBet()">
                            <span class="cab-btn-icon">&minus;</span>
                            <span class="cab-btn-label">ë² íŒ…</span>
                        </button>
                        <button class="cab-btn cab-btn-bet" onclick="SeaStory.increaseBet()">
                            <span class="cab-btn-icon">+</span>
                            <span class="cab-btn-label">ë² íŒ…</span>
                        </button>
                    </div>
                    <!-- ì¤‘: SPIN + MAX + AUTO -->
                    <div class="btn-group btn-group-center">
                        <button class="cab-btn cab-btn-maxbet" onclick="SeaStory.setBet(1000)">
                            <span class="cab-btn-label">ìµœëŒ€<br>ë² íŒ…</span>
                        </button>
                        <button class="cab-btn cab-btn-spin" id="spinButton" onclick="SeaStory.spin()">
                            <span class="cab-btn-label">ìŠ¤í•€</span>
                        </button>
                        <!-- ì˜¤í† ìŠ¤í•€: ë²„íŠ¼ + ì˜µì…˜ ë©”ë‰´ -->
                        <div class="auto-spin-wrapper">
                            <button class="cab-btn cab-btn-auto" id="autoSpinBtn" onclick="SeaStory.toggleAutoSpin()">
                                <span class="cab-btn-label">ìë™</span>
                            </button>
                            <div class="auto-spin-menu" id="autoSpinMenu" style="display:none">
                                <div class="auto-menu-title">ìë™ ìŠ¤í•€ íšŸìˆ˜</div>
                                <button class="auto-menu-item" onclick="SeaStory.startAutoSpin(10)">10íšŒ</button>
                                <button class="auto-menu-item" onclick="SeaStory.startAutoSpin(25)">25íšŒ</button>
                                <button class="auto-menu-item" onclick="SeaStory.startAutoSpin(50)">50íšŒ</button>
                                <button class="auto-menu-item" onclick="SeaStory.startAutoSpin(100)">100íšŒ</button>
                                <button class="auto-menu-item" onclick="SeaStory.startAutoSpin(-1)">ë¬´ì œí•œ</button>
                            </div>
                        </div>
                    </div>
                    <!-- ìš°: LINES ë””ìŠ¤í”Œë ˆì´ -->
                    <div class="btn-group btn-group-right">
                        <div class="lines-display">
                            <span class="lines-label">LINES</span>
                            <span class="lines-value">9</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- â•â•â• ê°¬ë¸”(ë”ë¸”ì—…) íŒ¨ë„ â•â•â• -->
            <div class="gamble-panel" id="gamblePanel" style="display:none">
                <div class="gamble-header">
                    ë”ë¸”ì—…! <span class="gamble-amount">0</span> ì¹©
                </div>
                <div class="gamble-hint">ë¬¼ê³ ê¸°ê°€ ì–´ëŠ ìª½ìœ¼ë¡œ í—¤ì—„ì¹ ê¹Œ? ë§ì¶”ë©´ 2ë°°!</div>
                <div class="gamble-card-area">
                    <div class="gamble-card" id="gambleCard">?</div>
                </div>
                <div class="gamble-buttons">
                    <button class="gamble-btn gamble-red" onclick="SeaStory.gambleDouble('red')">ğŸŸ ì™¼ìª½</button>
                    <button class="gamble-btn gamble-black" onclick="SeaStory.gambleDouble('black')">ğŸŸ ì˜¤ë¥¸ìª½</button>
                    <button class="gamble-btn gamble-collect" onclick="SeaStory.gambleCollect()">ë°›ê¸°</button>
                </div>
            </div>

            <!-- â•â•â• ë°°ë‹¹í‘œ (ê¸°ë³¸ ìˆ¨ê¹€, ë°°ë‹¹ ë²„íŠ¼ìœ¼ë¡œ í† ê¸€) â•â•â• -->
            <div class="paytable" id="paytableSection" style="display:none">
                <h3 class="paytable-title">ë°°ë‹¹í‘œ</h3>
                <div class="paytable-special">
                    <div class="paytable-special-item">
                        <span class="paytable-symbol wild-badge">ğŸ”± WILD</span>
                        <span class="paytable-desc">ì‚¼ì§€ì°½ì´ ë³´ë„ˆìŠ¤ ì œì™¸ ëª¨ë“  ì‹¬ë³¼ì„ ëŒ€ì²´í•©ë‹ˆë‹¤</span>
                    </div>
                    <div class="paytable-special-item">
                        <span class="paytable-symbol scatter-badge">âš“ BONUS</span>
                        <span class="paytable-desc">ë‹» 3ê°œ ì´ìƒ ì¶œí˜„ ì‹œ ë¬´ë£ŒìŠ¤í•€ (10/15/25íšŒ)</span>
                    </div>
                </div>
                <div class="paytable-grid" id="paytableGrid">
                    <!-- JS ìƒì„± -->
                </div>
                <p class="paytable-footer">
                    9 í˜ì´ë¼ì¸ &bull; 3ê°œ+ ì—°ì† ë§¤ì¹˜ &bull; ğŸ”± ì‚¼ì§€ì°½ WILD &bull; âš“ ë‹» BONUS ë¬´ë£ŒìŠ¤í•€
                </p>
            </div>

        </div>
    </main>

    <!-- â•â•â• ì˜¤ë²„ë ˆì´ â•â•â• -->
    <div class="free-spin-banner" id="freeSpinBanner">
        <div class="fs-text">ë¬´ë£Œ ìŠ¤í•€!</div>
    </div>

    <div class="win-overlay" id="winOverlay">
        <div class="win-content">
            <div class="win-tier-text">ë‹¹ì²¨!</div>
            <div class="win-amount">+0</div>
        </div>
    </div>

    <!-- ì½”ì¸ ìƒ¤ì›Œ ìº”ë²„ìŠ¤ -->
    <canvas id="coinShowerCanvas"></canvas>

    <div class="toast-container" id="toastContainer"></div>

    <!-- ë ˆë²¨ì—… ì˜¤ë²„ë ˆì´ -->
    <div class="levelup-overlay" id="levelupOverlay">
        <div class="levelup-content">
            <div class="levelup-title" id="levelupTitle">LEVEL UP!</div>
            <div class="levelup-bonus" id="levelupBonus">+0 ì¹©</div>
        </div>
    </div>

    <!-- í•˜ë‹¨ ë„¤ë¹„ê²Œì´ì…˜ (ëª¨ë°”ì¼) -->
    <nav class="bottom-nav">
        <div class="bottom-nav-inner">
            <a href="index.html" class="bottom-nav-item">
                <span class="nav-icon">ğŸ </span>
                <span class="nav-label">í™ˆ</span>
            </a>
            <a href="index.html#dailyBonusBanner" class="bottom-nav-item">
                <span class="nav-icon">ğŸ</span>
                <span class="nav-label">ë³´ë„ˆìŠ¤</span>
            </a>
            <button class="bottom-nav-item" onclick="SoundManager.toggleMute()">
                <span class="nav-icon">ğŸ”Š</span>
                <span class="nav-label">ì‚¬ìš´ë“œ</span>
            </button>
        </div>
    </nav>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <!-- ìŠ¤í¬ë¦½íŠ¸ -->
    <script src="js/core/firebase-config.js"></script>
    <script src="js/core/chip-manager.js"></script>
    <script src="js/core/sound-manager.js"></script>
    <script src="js/core/coin-shower.js"></script>
    <script src="js/core/level-manager.js"></script>
    <script src="js/games/sea-story.js"></script>
    <script>
        // í˜ì´í…Œì´ë¸” í† ê¸€
        let _paytableVisible = false;
        function togglePaytable() {
            const section = document.getElementById('paytableSection');
            if (!section) return;
            _paytableVisible = !_paytableVisible;
            section.style.display = _paytableVisible ? 'block' : 'none';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            await ChipManager.init();
            SoundManager.init();
            CoinShower.init();
            LevelManager.init();

            ChipManager.onBalanceChange(() => {
                document.getElementById('headerChips').textContent = ChipManager.formatBalance();
                document.getElementById('creditDisplay').textContent = ChipManager.getBalance().toLocaleString();
            });
            document.getElementById('headerChips').textContent = ChipManager.formatBalance();
            document.getElementById('creditDisplay').textContent = ChipManager.getBalance().toLocaleString();

            // ë ˆë²¨ì—… ë¦¬ìŠ¤ë„ˆ
            LevelManager.onEvent((event) => {
                if (event.type === 'levelup') {
                    const overlay = document.getElementById('levelupOverlay');
                    if (overlay) {
                        document.getElementById('levelupTitle').textContent = `LEVEL ${event.level}!`;
                        document.getElementById('levelupBonus').textContent = `+${event.bonus.toLocaleString()} ë³´ë„ˆìŠ¤ ì¹©`;
                        overlay.classList.add('active');
                        setTimeout(() => overlay.classList.remove('active'), 3000);
                    }
                }
            });

            SeaStory.init();
            _buildPaytable();
            _initBubbles();
        });

        // í˜ì´í…Œì´ë¸” ìƒì„±
        function _buildPaytable() {
            const grid = document.getElementById('paytableGrid');
            if (!grid) return;
            grid.innerHTML = '';
            SeaStory.SYMBOLS.forEach(sym => {
                if (sym.type === 'wild' || sym.type === 'scatter') return;
                const item = document.createElement('div');
                item.className = 'paytable-item';
                item.innerHTML = `
                    <span class="pt-symbol">${sym.label || sym.name}</span>
                    <span class="paytable-info">
                        <span class="pt-name">${sym.name}</span>
                        <span class="pt-pays">
                            <span class="multiplier">x${sym.pay[0]}</span>
                            <span class="multiplier">x${sym.pay[1]}</span>
                            <span class="multiplier">x${sym.pay[2]}</span>
                        </span>
                    </span>
                `;
                grid.appendChild(item);
            });
        }

        // ë²„ë¸” ë°°ê²½ íš¨ê³¼
        function _initBubbles() {
            const canvas = document.getElementById('bubbleCanvas');
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            let bubbles = [];

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            resize();
            window.addEventListener('resize', resize);

            // ë²„ë¸” ìƒì„±
            for (let i = 0; i < 25; i++) {
                bubbles.push({
                    x: Math.random() * canvas.width,
                    y: canvas.height + Math.random() * 200,
                    r: 2 + Math.random() * 6,
                    speed: 0.3 + Math.random() * 0.8,
                    wobble: Math.random() * Math.PI * 2,
                    wobbleSpeed: 0.01 + Math.random() * 0.02,
                    opacity: 0.1 + Math.random() * 0.25
                });
            }

            function animate() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                bubbles.forEach(b => {
                    b.y -= b.speed;
                    b.wobble += b.wobbleSpeed;
                    const wx = b.x + Math.sin(b.wobble) * 15;

                    if (b.y < -20) {
                        b.y = canvas.height + 10;
                        b.x = Math.random() * canvas.width;
                    }

                    ctx.beginPath();
                    ctx.arc(wx, b.y, b.r, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(100, 200, 255, ${b.opacity})`;
                    ctx.fill();
                    // í•˜ì´ë¼ì´íŠ¸
                    ctx.beginPath();
                    ctx.arc(wx - b.r * 0.3, b.y - b.r * 0.3, b.r * 0.3, 0, Math.PI * 2);
                    ctx.fillStyle = `rgba(200, 240, 255, ${b.opacity * 1.5})`;
                    ctx.fill();
                });
                requestAnimationFrame(animate);
            }
            animate();
        }

        // í‚¤ë³´ë“œ: Space=ìŠ¤í•€, Space ì¤‘ ìŠ¤í•€=í€µìŠ¤í†±
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                SeaStory.spin();
            }
        });
    </script>
</body>
</html>
